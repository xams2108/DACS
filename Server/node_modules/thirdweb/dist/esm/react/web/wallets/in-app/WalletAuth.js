import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import { Suspense, useRef, useState } from "react";
import { defineChain } from "../../../../chains/utils.js";
import { getDefaultWallets } from "../../../../wallets/defaultWallets.js";
import { isEcosystemWallet } from "../../../../wallets/ecosystem/is-ecosystem-wallet.js";
import { linkProfile } from "../../../../wallets/in-app/web/lib/auth/index.js";
import { iconSize } from "../../../core/design-system/index.js";
import { useAddConnectedWallet } from "../../../core/hooks/wallets/useAddConnectedWallet.js";
import AllWalletsUI from "../../ui/ConnectWallet/Modal/AllWalletsUI.js";
import { WalletSelector } from "../../ui/ConnectWallet/WalletSelector.js";
import { Spacer } from "../../ui/components/Spacer.js";
import { WalletImage } from "../../ui/components/WalletImage.js";
import { Container, ModalHeader } from "../../ui/components/basic.js";
import { ErrorState } from "../shared/ErrorState.js";
import { LoadingScreen } from "../shared/LoadingScreen.js";
import { LoadingState } from "../shared/LoadingState.js";
export function WalletAuth(props) {
    const { wallet, done } = props;
    const addConnectedWallet = useAddConnectedWallet();
    const walletToConnect = useRef(undefined);
    const [status, setStatus] = useState("selecting");
    const [error, setError] = useState();
    const [showAll, setShowAll] = useState(false);
    const ecosystem = isEcosystemWallet(wallet)
        ? {
            id: wallet.id,
            partnerId: wallet.getConfig()?.partnerId,
        }
        : undefined;
    const back = () => {
        setStatus("selecting");
        walletToConnect.current = undefined;
        props.onBack();
    };
    async function login(walletToLink) {
        setStatus("loading");
        setError(undefined);
        walletToConnect.current = walletToLink;
        try {
            if (props.isLinking) {
                await linkProfile({
                    client: props.client,
                    strategy: "wallet",
                    wallet: walletToLink,
                    chain: props.chain || wallet.getChain() || defineChain(1),
                    ecosystem,
                });
            }
            else {
                await wallet.connect({
                    client: props.client,
                    strategy: "wallet",
                    wallet: walletToLink,
                    chain: props.chain || walletToLink.getChain() || defineChain(1),
                });
            }
            addConnectedWallet(walletToLink);
            done();
        }
        catch (e) {
            setError(e instanceof Error ? e.message : "Unknown error");
            setStatus("error");
        }
    }
    if (!walletToConnect.current) {
        if (showAll) {
            return (_jsx(Suspense, { fallback: _jsx(LoadingScreen, {}), children: _jsx(AllWalletsUI, { onBack: () => setShowAll(false), onSelect: async (newWallet) => {
                        login(newWallet);
                        setShowAll(false);
                    }, client: props.client, connectLocale: props.locale, recommendedWallets: undefined, specifiedWallets: [], size: props.size, disableSelectionDataReset: true }) }));
        }
        return (_jsx(WalletSelector, { title: props.locale.connectAWallet, wallets: getDefaultWallets(), selectWallet: async (newWallet) => {
                login(newWallet);
            }, onShowAll: () => {
                setShowAll(true);
            }, done: () => { }, goBack: back, setModalVisibility: () => { }, client: props.client, connectLocale: props.locale, hideHeader: false, recommendedWallets: undefined, chain: wallet.getChain(), showAllWallets: true, chains: [], size: props.size, meta: props.meta || {}, walletConnect: props.walletConnect, modalHeader: {
                title: props.isLinking
                    ? props.inAppLocale.linkWallet
                    : props.inAppLocale.signInWithWallet,
                onBack: back,
            }, walletIdsToHide: ["inApp"], disableSelectionDataReset: true }));
    }
    return (_jsxs(Container, { animate: "fadein", fullHeight: true, flex: "column", children: [_jsx(Container, { p: "lg", children: _jsx(ModalHeader, { title: props.isLinking
                        ? props.inAppLocale.linkWallet
                        : props.inAppLocale.signInWithWallet, onBack: back }) }), _jsx(Container, { px: props.size === "wide" ? "xxl" : "lg", expand: true, flex: "column", center: "y", children: _jsx("div", { children: status === "error" ? (_jsxs(_Fragment, { children: [_jsx(ErrorState, { onTryAgain: () => {
                                    if (!walletToConnect.current) {
                                        throw new Error("Failed to connect to unknown wallet");
                                    }
                                    login(walletToConnect.current);
                                }, title: error || "Failed to Login" }), _jsx(Spacer, { y: "lg" })] })) : (_jsx(_Fragment, { children: _jsx(LoadingState, { title: "Sign in with your wallet", subtitle: "A pop-up prompt will appear to sign-in and verify your wallet", icon: _jsx(WalletImage, { id: walletToConnect.current.id ?? "", size: iconSize.xl, client: props.client }) }) })) }) })] }));
}
//# sourceMappingURL=WalletAuth.js.map